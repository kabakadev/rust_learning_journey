name: Verify Rust Progress

on:
  push:
    branches: ["main"]
    paths:
      - "chapter_*/**" # Watch Chapters
      - "quest_*/**" # Watch Side Quests
      - "Cargo.toml" # Watch the Workspace Config
      - "Cargo.lock" # Watch Dependencies

jobs:
  check-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Detect Changed Chapter
        id: detect
        shell: bash
        run: |
          # 1. Find modified chapter OR quest folders
          # "|| true" prevents the script from crashing if grep finds nothing
          CHANGED_FILE=$(git diff --name-only HEAD^ HEAD | grep -E "(chapter_|quest_)" | head -n 1 || true)

          if [ -z "$CHANGED_FILE" ]; then
            echo "No specific chapter code changed (maybe just Cargo.toml?)."
            echo "chapter=none" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. Extract just the directory name (e.g., chapter_01... or quest_01...)
          CHAPTER=$(echo $CHANGED_FILE | cut -d'/' -f1)

          echo "Detected change in: $CHAPTER"
          echo "chapter=$CHAPTER" >> $GITHUB_OUTPUT

      - name: Install Rust Toolchain
        if: steps.detect.outputs.chapter != 'none'
        uses: dtolnay/rust-toolchain@stable # Updated to the modern reliable action

      - name: Run Tests
        if: steps.detect.outputs.chapter != 'none'
        run: |
          echo "Running tests for ${{ steps.detect.outputs.chapter }}..."
          cd ${{ steps.detect.outputs.chapter }}
          cargo test --verbose

      - name: Notify Termux Server
        if: success() && steps.detect.outputs.chapter != 'none'
        run: |
          echo "Tests Passed! Notifying server..."
          curl -X POST https://ian-dev.top/api/update-progress \
          -H "Content-Type: application/json" \
          -H "x-api-key: ${{ secrets.API_KEY }}" \
          -d "{\"chapter\": \"${{ steps.detect.outputs.chapter }}\", \"passed\": true}"
